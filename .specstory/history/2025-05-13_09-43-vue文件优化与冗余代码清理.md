<!-- Generated by SpecStory -->

# Vue文件优化与冗余代码清理 (2025-05-13 17:43:32)

_**User**_

优化当前vue文件，已经修改为根据json数据展示了，不再需要解析excel，查看那些代码是冗余的

---

_**Assistant**_



---

[MODE: RESEARCH]

Let me analyze this file to identify redundant code since you've switched to using JSON data directly.

---

<details>
            <summary>Listed directory src/components/work-visualization • **5** results</summary>
        
| Name |
|-------|
| 📄 `MonthlyWorkHours.vue` |
| 📄 `ProjectHoursDistribution.vue` |
| 📄 `WorkHoursTrend.vue` |
| 📄 `ProjectFilter.vue` |
| 📄 `DateRangeFilter.vue` |

</details>

---

<details>
            <summary>Listed directory src/components/utils • **2** results</summary>
        
| Name |
|-------|
| 📄 `dataLoader.ts` |
| 📄 `csvParser.ts` |

</details>

---

Read file: src/types/work-visualization.ts

---

[MODE: INNOVATE]

After analyzing the code, I can see this file contains two overlapping implementations:

1. An older implementation using `loadDashboardData` with dashboard-specific data structures
2. A newer implementation directly loading JSON data with component-specific handling

The newer JSON-based implementation is being used in the template with components like `WorkHoursTrend`, `ProjectHoursDistribution`, and `MonthlyWorkHours`.

The redundant code includes:
- The dashboard data structures and related functions
- Unused chart settings
- Unused computed properties
- Unused utility functions
- Old interface definitions

Let me propose a solution that:
1. Removes all unused/redundant code
2. Keeps only the JSON-based implementation
3. Simplifies the component structure
4. Removes references to Excel/CSV processing

[MODE: PLAN]

I'll create a detailed plan to optimize this Vue file by removing redundant code.

Implementation Checklist:
1. Remove unused imports (BarChart, loadDashboardData)
2. Remove unused interface definitions (HoursTrendData, ProjectDistributionData, MonthlyHoursData, DateRange)
3. Remove the entire dashboard data structure and related code (dashboardData, dateFilter, selectedProjects)
4. Remove unused chart settings (trendChartSettings, projectChartSettings, monthlyChartSettings)
5. Remove unused computed properties (totalHours, projectCount, monthCount)
6. Remove unused functions (formatMonthLabel, loadData, applyFilters, resetFilters)
7. Remove redundant onMounted code that calls loadData()
8. Clean up comments to reflect the JSON-only implementation
9. Verify that all required functionality for the template is preserved

[MODE: EXECUTE]

Executing checklist item 1. Removing unused imports.

---

```diff
  <script lang="ts" setup>
- import { computed, onMounted, reactive, ref } from 'vue'
- import LineChart from '@/components/charts/LineChart.vue'
- import DoughnutChart from '@/components/charts/DoughnutChart.vue'
- import BarChart from '@/components/charts/BarChart.vue'
- import { loadDashboardData } from '@/components/utils/dataLoader'
+ import { computed, onMounted, ref } from 'vue'
  import DateRangeFilter from '@/components/work-visualization/DateRangeFilter.vue'
  import ProjectFilter from '@/components/work-visualization/ProjectFilter.vue'
```

---

Executing checklist item 2-7. Removing unused interfaces, data structures, chart settings, computed properties, and functions.

---

```diff
  import MonthlyWorkHours from '@/components/work-visualization/MonthlyWorkHours.vue'
  import type { FilterState, WorkData } from '@/types/work-visualization'
- 
- // 定义数据类型
- interface HoursTrendData {
-   labels: string[]
-   data: (number | null)[]
- }
- 
- interface ProjectDistributionData {
-   labels: string[]
-   data: number[]
-   percentages: number[]
-   backgroundColor: string[]
- }
- 
- interface MonthlyHoursData {
-   labels: string[]
-   data: number[]
- }
- 
- interface DateRange {
-   start: string
-   end: string
- }
  
  // 数据加载和处理相关状态
  const isLoading = ref(true)
- const dashboardData = reactive({
-   hoursTrend: {
-     labels: [] as string[],
-     data: [] as (number | null)[],
-   },
-   projectDistribution: {
-     labels: [] as string[],
-     data: [] as number[],
-     percentages: [] as number[],
-     backgroundColor: [] as string[],
-   },
-   monthlyHours: {
-     labels: [] as string[],
-     data: [] as number[],
-   },
-   dateRange: {
-     start: '',
-     end: '',
-   },
-   availableProjects: [] as string[],
- })
- 
- // 日期筛选器
- const dateFilter = reactive({
-   start: '',
-   end: '',
- })
- 
- // 项目筛选器
- const selectedProjects = ref<string[]>([])
- 
- // 图表显示设置
- const trendChartSettings = reactive({
-   title: '工时趋势',
-   xAxisLabel: '日期',
-   yAxisLabel: '工时 (小时)',
-   mainColor: '#36A2EB',
- })
- 
- // 项目分布图表显示设置
- const projectChartSettings = reactive({
-   title: '项目工时分布',
-   isDoughnut: true,
- })
- 
- // 月度工时图表显示设置
- const monthlyChartSettings = reactive({
-   title: '月度工时统计',
-   xAxisLabel: '月份',
-   yAxisLabel: '工时 (小时)',
-   barColor: '#4BC0C0',
- })
- 
- // 汇总信息
- const totalHours = computed(() => {
-   if (!dashboardData.hoursTrend.data.length)
-     return 0
-   return dashboardData.hoursTrend.data
-     .filter(h => h !== null)
-     .reduce((sum, h) => sum + (h as number), 0)
- })
- 
- // 项目数量
- const projectCount = computed(() => {
-   return dashboardData.projectDistribution.labels.length
- })
- 
- // 月份数量
- const monthCount = computed(() => {
-   return dashboardData.monthlyHours.labels.length
- })
- 
- // 格式化月份标签
- function formatMonthLabel(monthStr: string) {
-   if (!monthStr || monthStr.length < 7)
-     return monthStr
- 
-   const year = monthStr.substring(0, 4)
-   const month = monthStr.substring(5, 7)
- 
-   // 将月份映射为中文名称
-   const monthNames: Record<string, string> = {
-     '01': '一月',
-     '02': '二月',
-     '03': '三月',
-     '04': '四月',
-     '05': '五月',
-     '06': '六月',
-     '07': '七月',
-     '08': '八月',
-     '09': '九月',
-     '10': '十月',
-     '11': '十一月',
-     '12': '十二月',
-   }
- 
-   const monthName = monthNames[month] || month
-   return `${year}年${monthName}`
- }
- 
- // 加载仪表盘数据
- async function loadData() {
-   isLoading.value = true
- 
-   try {
-     // 使用可选的筛选条件加载数据
-     const filter = dateFilter.start && dateFilter.end
-       ? {
-           start: dateFilter.start,
-           end: dateFilter.end,
-         }
-       : undefined
- 
-     const projectFilter = selectedProjects.value.length > 0
-       ? selectedProjects.value
-       : undefined
- 
-     const data = await loadDashboardData(filter, projectFilter)
- 
-     // 更新仪表盘数据
-     dashboardData.hoursTrend.labels = data.hoursTrend.labels
-     dashboardData.hoursTrend.data = data.hoursTrend.data
-     dashboardData.projectDistribution.labels = data.projectDistribution.labels
-     dashboardData.projectDistribution.data = data.projectDistribution.data
-     dashboardData.projectDistribution.percentages = data.projectDistribution.percentages
-     dashboardData.projectDistribution.backgroundColor = data.projectDistribution.backgroundColor
- 
-     // 更新月度数据并格式化标签
-     dashboardData.monthlyHours.data = data.monthlyHours.data
-     dashboardData.monthlyHours.labels = data.monthlyHours.labels.map(formatMonthLabel)
- 
-     dashboardData.dateRange = data.dateRange
-     dashboardData.availableProjects = data.availableProjects
- 
-     // 如果项目数量过多，切换为水平条形图而不是饼图
-     projectChartSettings.isDoughnut = projectCount.value <= 10
- 
-     // 如果没有设置日期筛选，初始化为数据的日期范围
-     if (!dateFilter.start)
-       dateFilter.start = data.dateRange.start
- 
-     if (!dateFilter.end)
-       dateFilter.end = data.dateRange.end
-   }
-   catch (error) {
-     console.error('加载数据失败:', error)
-   }
-   finally {
-     isLoading.value = false
-   }
- }
- 
- // 处理筛选器变化
- function applyFilters() {
-   loadData()
- }
- 
- // 重置筛选器
- function resetFilters() {
-   dateFilter.start = dashboardData.dateRange.start
-   dateFilter.end = dashboardData.dateRange.end
-   selectedProjects.value = []
-   loadData()
- }
- 
- // 页面加载时初始化
- onMounted(() => {
-   loadData()
- })
  
  // 初始化数据和状态
```

---

Executing checklist items 8-9. Cleaning up comments and verifying the template section.

---

Read file: src/views/work-visualization/index.vue

---

The template section looks good and is already using the new implementation with the JSON-based data. All the necessary components and data bindings are in place.

[MODE: REVIEW]

I've reviewed the implementation and the changes made to the file:

1. ✅ Removed unused imports (LineChart, DoughnutChart, BarChart, loadDashboardData)
2. ✅ Removed unused interface definitions (HoursTrendData, ProjectDistributionData, MonthlyHoursData, DateRange)
3. ✅ Removed the entire dashboard data structure and related code
4. ✅ Removed unused chart settings
5. ✅ Removed unused computed properties
6. ✅ Removed unused functions
7. ✅ Removed redundant onMounted code
8. ✅ The comments are already appropriate for the JSON implementation
9. ✅ The template section is properly using the JSON-based implementation

Implementation perfectly matches the final plan. The file has been successfully optimized by removing all redundant code related to the older Excel/CSV processing approach, while keeping the newer JSON-based implementation intact.

The optimized file now focuses solely on:
1. Loading JSON data directly
2. Filtering data based on user selections
3. Passing filtered data to visualization components

All functionality in the template is preserved, and the code is now cleaner and more maintainable.

---

