# 工时数据可视化需求文档（第二版）

## 1. 项目背景与目标

本项目旨在将 `日期-工作表1.csv` 文件中记录的兼职工作工时数据进行处理和可视化。目标是通过直观的图表展示工作量、项目分配和时间趋势，方便用户分析和回顾工作情况。最终产物是一个在当前项目中新增的路由页面，使用 Chart.js 实现图表展示。

## 2. 数据源与预处理

### 2.1 原始数据源

- **文件**: `日期-工作表1.csv`
- **主要数据列**: `日期`, `工时(小时)`, `项目`, `工作内容简述`, `人员`

### 2.2 数据预处理流程 (新增)

与第一版不同，本版本将数据处理从前端移至预处理阶段:

1. 创建数据预处理脚本，负责:
   - 读取 CSV 文件
   - 执行数据清洗与解析
   - 生成标准化的 JSON 数据文件
2. 前端直接加载处理好的 JSON 文件，无需再进行 CSV 解析

## 3. 数据处理与 JSON 转换

### 3.1. 数据清洗与解析逻辑

1. **读取 CSV 文件**: 逐行读取 CSV 内容。
2. **识别并跳过无效行**:
   - **汇总行**: 忽略仅包含单个数字 (如 `,68,,,,`) 或以 "总" 开头 (如 `总27,,,,,`) 的行。这些汇总数据将由前端逻辑根据原始数据动态计算。
   - **空行**: 忽略所有字段均为空的行 (如 `,,,,,`)。
3. **解析有效数据行**:
   - **标准格式行**: 对于以 `YYYY/MM/DD` 或 `YYYY-MM-DD` 开头的标准逗号分隔行，按列提取数据。
     - `日期`: 统一转换为 `YYYY-MM-DD` 格式，同时添加对应的 Unix 时间戳。
     - `工时(小时)`: 转换为数字类型。若为空或无法转换，则该行可能需要特殊处理或标记为错误。
     - `项目`, `工作内容简述`, `人员`: 作为字符串读取。
   - **特殊格式行**: 对于末尾出现的引号内嵌数据行 (如 `"2025-03-19 2 课程后台系统 ..."`)：
     - 移除首尾引号。
     - 按空格进行初步分割。通常格式为 `YYYY-MM-DD 工时 项目 描述...`。
     - 提取 `日期` (第一个空格前的内容)，同时添加对应的 Unix 时间戳。
     - 提取 `工时` (第二个空格前的内容，转换为数字)。
     - 提取 `项目` (第三个空格前的内容)。
     - 剩余部分作为 `工作内容简述`。
     - `人员` 字段在此类行中通常缺失，可置为空字符串。
4. **数据校验**: 对提取的日期格式、工时是否为数字等进行基础校验。

### 3.2. 目标 JSON 结构 (更新)

处理后的数据将保存为 JSON 文件，格式为对象数组。每个对象代表一条有效的工时记录，增加了时间戳字段：

```json
[
  {
    "date": "YYYY-MM-DD", // 标准化日期字符串
    "timestamp": 1640995200000, // Unix 时间戳 (毫秒)
    "hours": 2, // 工时 (数值型)
    "project": "String", // 项目名称
    "description": "String", // 工作内容简述
    "personnel": "String" // 人员 (可能为空)
  }
  // ... 更多记录
]
```

此 JSON 数据将保存为静态文件 (如 `work-data.json`)，供前端直接加载使用。

## 4. 可视化页面设计

### 4.1. 页面路由

- 新增路由: 例如 `/work-visualization` 或 `/timesheet-dashboard`。

### 4.2. 技术选型

- 图表库: `Chart.js`
- 数据加载: 从 JSON 文件加载 (替代原计划中的 CSV 解析)

### 4.3. 页面布局

- 考虑采用仪表盘 (Dashboard) 风格布局，清晰展示多个图表。
- 包含全局筛选器区域 (如日期范围选择)。
- **响应式设计**: 页面需采用响应式设计，确保在不同尺寸的设备（桌面Web端和移动端）上均有良好的用户体验和可读性。`Chart.js` 本身支持响应式调整图表大小，但整体布局、筛选器等其他UI元素也需要适配。

### 4.4. 图表实现方案

以下是计划实现的图表：

**图表 1: 工时趋势分析 (Work Hours Trend Analysis)**

- **类型**: 折线图 (Line Chart)
- **数据**:
  - X 轴: 日期 (按日聚合)
  - Y 轴: 当日总工时
- **描述**: 展示每日工作时长的变化趋势。
- **零工时处理**: 对于当日工时为零的情况，对应数据点将处理为 `null` 或 `NaN`，使得折线图在该处形成视觉上的断点（Gap），以更清晰地突出有工时的时段。
- **交互**: 支持通过日期范围筛选器调整显示区间 (使用时间戳进行筛选)。工具提示 (Tooltip) 显示具体日期和工时。提供按周 / 按月聚合查看的选项。

**图表 2: 项目工时分布 (Project Hours Distribution)**

- **类型**: 饼图 (Pie Chart) 或 甜甜圈图 (Doughnut Chart)。若项目数量较多导致饼图可读性下降，则自动切换或提供选项使用水平条形图 (Horizontal Bar Chart)。
- **数据**:
  - 各个项目累计工时占总工时的百分比。
- **描述**: 直观显示时间在不同项目上的分配比例。
- **交互**: 点击扇区可高亮，工具提示显示项目名称、工时和百分比。

**图表 3: 月度工时统计 (Monthly Work Hours Summary)**

- **类型**: 柱状图 (Bar Chart)
- **数据**:
  - X 轴: 月份 (例如 "2024-05", "2024-06")
  - Y 轴: 每月总工时
- **描述**: 对比各个月份的总工作时长。
- **交互**: 支持通过日期范围筛选器影响显示的月份 (使用时间戳进行筛选)。工具提示显示具体月份和总工时。

### 4.5. 交互功能 (更新)

- **全局日期范围筛选器**:
  - 允许用户选择开始日期和结束日期
  - **使用时间戳进行筛选**: 将用户选择的日期转换为时间戳，并基于时间戳进行数据筛选，解决之前基于日期字符串筛选不起作用的问题
  - 所有图表根据所选范围动态更新
- **项目筛选器**: 允许用户选择一个或多个特定项目，工时趋势图和月度统计图将动态更新，只显示与所选项目相关的数据。
- **数据动态加载与计算**: 前端逻辑负责根据 JSON 数据动态计算各图表所需的聚合数据 (如每日总工时、每月总工时、各项目总工时等)。

## 5. 实现清单 (Implementation Checklist) (更新)

1. **数据预处理脚本开发** (新增):
   - 创建脚本 (使用 Node.js 或 Python) 实现 CSV 到 JSON 的转换。
   - 实现 CSV 解析逻辑，能够处理 `日期-工作表1.csv` 中的各种行格式。
   - 转换日期为标准格式并添加对应的时间戳。
   - 输出符合目标 JSON 结构的数据文件 (如 `work-data.json`)。

2. **环境搭建**: 确保项目中已安装或可引入 `Chart.js` 库。

3. **创建新路由与页面组件**:
   - 定义路由 `/work-visualization`。
   - 创建对应的页面组件 (例如 `WorkVisualization.vue` 或 `WorkVisualization.jsx`，根据项目技术栈而定)。
   - 页面组件需考虑响应式布局。

4. **数据加载模块** (更新):
   - 实现加载预处理好的 JSON 数据文件的函数。
   - 提供数据筛选与处理的工具函数 (使用时间戳进行日期筛选)。
   - 在数据处理阶段，针对工时趋势图的数据，将零工时日的工时值处理为 `null` 或 `NaN`。

5. **图表组件封装**:
   - 为每种图表类型 (折线图、饼图/水平条形图、柱状图) 创建可复用的、响应式的图表组件，接收处理好的数据作为 props。

6. **实现图表 1 (工时趋势分析)**:
   - 加载 JSON 数据，按日期聚合计算每日总工时（零工时处理为null）。
   - 使用封装好的折线图组件进行绘制。
   - 集成基于时间戳的日期范围筛选功能。
   - 实现按周/月聚合查看功能。

7. **实现图表 2 (项目工时分布)**:
   - 加载 JSON 数据，计算各项目总工时及其占比。
   - 使用封装好的饼图/水平条形图组件进行绘制（根据项目数量决定具体图表类型）。
   - 集成基于时间戳的日期范围筛选功能。

8. **实现图表 3 (月度工时统计)**:
   - 加载 JSON 数据，按月份聚合计算每月总工时。
   - 使用封装好的柱状图组件进行绘制。
   - 集成基于时间戳的日期范围筛选功能。

9. **实现全局筛选器** (更新):
   - 开发并集成日期范围选择组件，**确保日期选择被转换为时间戳用于数据筛选**。
   - 开发并集成项目选择组件。
   - 确保所有图表组件响应筛选器的变化并更新数据。

10. **页面布局与样式**:
    - 设计和实现响应式的页面整体布局和美化，确保在桌面和移动端均有良好显示效果。

11. **测试与优化**:
    - 测试数据预处理脚本的准确性。
    - 测试基于时间戳的日期筛选功能。
    - 测试各图表在不同数据量和筛选条件下的显示效果和性能。
    - 测试响应式布局在不同设备和屏幕尺寸下的表现。
    - 确保交互流畅。

---

该文档后续可根据实际开发进展进行迭代和完善。
