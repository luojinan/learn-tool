<!-- Generated by SpecStory -->

# API Data Loading with Caching (2025-01-07 11:48:01)

_**User**_

获取数据从oss中加载umd数据改为请求接口，缓存功能要求保留，接口为“@https://monkey.5675675.xyz/api/income/?owner=luo”

---

_**Assistant**_

I'll help you modify the code to fetch data from the API while keeping the caching functionality. First, let me analyze the current code and then make the necessary changes.

I'll need to modify the `cacheDataOrUmd` function in `utils.ts` to handle API requests instead of UMD loading. Here's how I'll do it:


---

```diff
    }
    try {
-     await loadScript(url)
-     localStorage.setItem(globalName, JSON.stringify(window[globalName]))
+     const response = await fetch(url)
+     if (!response.ok) {
+       throw new Error(`HTTP error! status: ${response.status}`)
+     }
+     const data = await response.json()
+     localStorage.setItem(globalName, JSON.stringify(data))
      return Promise.resolve({
-       data: window[globalName],
+       data,
        msg: '来源网络',
      })
```

---

Now I'll update the income component to use the new API endpoint:


---

```diff
    const dataPath = 'incomeData'
    const dataName = 'incomeDataList'
-   const dataUrl = `${ossDataUrl}/${dataPath}.js`
+   const dataUrl = 'https://monkey.5675675.xyz/api/income/?owner=luo'
    const { data, msg } = await cacheDataOrUmd(dataName, dataUrl)
    dataMsg.value = msg
```

---

I've made the following changes:

1. Modified the `cacheDataOrUmd` function in `utils.ts` to:
   - Use `fetch` to make API requests instead of loading UMD scripts
   - Keep the caching functionality using localStorage
   - Handle API response errors appropriately

2. Updated the `getIncomeData` function in `income/index.vue` to:
   - Use the new API endpoint URL
   - Keep the same caching mechanism through the `cacheDataOrUmd` function

The changes maintain the existing caching functionality while switching from UMD loading to API requests. The data will still be cached in localStorage and reused when available, but now it will be fetched from the API endpoint when not in cache.

The linter errors that appeared are related to TypeScript type definitions in the income component, but they're not directly related to our changes. They would require adding proper type definitions to the component, which is outside the scope of the current task.

Would you like me to help you fix those TypeScript type issues as well?

---

